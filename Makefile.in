prefix=@prefix@
HCOMPILER=@HCOMPILER@
HFLAGS=@HFLAGS@
HAPPY=@HAPPY@
INSTALL=@INSTALL@
DESTDIR=
RTSS=$(wildcard rts*)

export prefix HCOMPILER HFLAGS HAPPY INSTALL DESTDIR RTSS


SRC   = @SRC@

DEST  = @DEST@

LIB_T = $(wildcard lib/*.t)
LIB_C = $(LIB_T:.t=.c)
LIB_H = $(LIB_T:.t=.h)

all: compiler rts

compiler: $(DEST) Parser.hs
	$(HCOMPILER) $(HFLAGS) $(DEST) $(SRC) 

Parser.hs: Parser.y
	$(HAPPY) Parser.y

rts: $(DEST)
	@for rts in $(RTSS); do \
		echo Making $$rts; \
		$(MAKE) -C $$rts; \
	done

install: ${DEST}
	$(INSTALL) -d $(DESTDIR)$(prefix)/bin
	$(INSTALL) -d $(DESTDIR)$(prefix)/lib
	$(INSTALL) -d $(DESTDIR)$(prefix)/include
	$(INSTALL) timberc $(DESTDIR)$(prefix)/bin
	$(INSTALL) lib/* $(DESTDIR)$(prefix)/lib
	$(INSTALL) include/* $(DESTDIR)$(prefix)/include
	@for rts in $(RTSS); do \
		echo Installing $$rts; \
		$(MAKE) install -C $$rts; \
	done

clean:
	rm -f *.o *.hi $(DEST) 
	rm -f $(LIB_C) $(LIB_H)
	@for rts in $(RTSS); do \
		echo Cleaning $$rts; \
		$(MAKE) clean -C $$rts; \
	done

distclean: clean
	rm -f Makefile config.h	
	@for rts in $(RTSS); do \
		echo Distcleaning $$rts; \
		$(MAKE) distclean -C $$rts; \
	done

